name: Build MangoHud RootFS for Winlator

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      inputMangoHudVersion:
        description: "MangoHud version"
        required: true
        default: "v0.7.1"
      inputMangoHudCommit:
        description: "MangoHud commit hash (optional)"
        required: false
        default: ""
      inputCustomTag:
        description: "Custom tag name"
        required: true
        default: "beta11-mangohud"

env:
  mangohudVer: ${{ github.event.inputs.inputMangoHudVersion }}
  mangohudCommit: ${{ github.event.inputs.inputMangoHudCommit }}
  customTag: ${{ github.event.inputs.inputCustomTag }}

jobs:
  build-rootfs:
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            arch-bootstrap.sh
            build-mangohud-rootfs.sh
            data.tar.xz
            tzdata-2025b-1-aarch64.pkg.tar.xz

      - name: Setup chroot environment
        run: |
          sudo apt update
          sudo apt install -y coreutils curl sed gawk tar gzip xz-utils zstd
          
          # Make arch-bootstrap executable
          chmod +x arch-bootstrap.sh
          sudo cp arch-bootstrap.sh /usr/local/bin/arch-bootstrap
          
          # Create chroot environment
          cd /tmp
          sudo arch-bootstrap -a aarch64 archlinux

      - name: Install build dependencies in chroot
        run: |
          # Create dependency installation script
          cat > /tmp/install-deps.sh << 'EOF'
          #!/bin/bash
          pacman -Syu --noconfirm
          pacman-key --init
          pacman -S --noconfirm --needed \
            base-devel \
            git \
            cmake \
            meson \
            ninja \
            glib2-devel \
            libx11 \
            mesa \
            vulkan-headers \
            vulkan-icd-loader \
            vulkan-tools \
            vulkan-validation-layers \
            libglvnd \
            dbus \
            gcc \
            make \
            pkg-config \
            python3 \
            git \
            python-mako \
            patchelf \
            wget \
            ca-certificates
          exit 0
          EOF
          
          sudo chmod +x /tmp/install-deps.sh
          sudo cp /tmp/install-deps.sh /tmp/archlinux/
          
          # Mount required filesystems
          sudo mount --bind /proc /tmp/archlinux/proc
          sudo mount --bind /sys /tmp/archlinux/sys
          sudo mount --bind /dev /tmp/archlinux/dev
          
          # Install dependencies in chroot
          sudo chroot /tmp/archlinux /install-deps.sh
          
          # Cleanup
          sudo rm /tmp/archlinux/install-deps.sh

      - name: Prepare build files in chroot
        run: |
          # Copy build script and data files
          sudo cp build-mangohud-rootfs.sh /tmp/archlinux/tmp/
          sudo cp data.tar.xz /tmp/archlinux/tmp/
          sudo cp tzdata-2025b-1-aarch64.pkg.tar.xz /tmp/archlinux/tmp/
          
          # Create init script with environment variables
          cat > /tmp/init.sh << EOF
          export mangohudVer=$mangohudVer
          export mangohudCommit=$mangohudCommit
          export customTag=$customTag
          EOF
          
          sudo cp /tmp/init.sh /tmp/archlinux/tmp/
          sudo chmod +x /tmp/archlinux/tmp/build-mangohud-rootfs.sh

      - name: Build rootfs with MangoHud
        run: |
          # Execute build script in chroot
          sudo chroot /tmp/archlinux /tmp/build-mangohud-rootfs.sh
          
          # Unmount filesystems
          sudo umount -l /tmp/archlinux/dev
          sudo umount -l /tmp/archlinux/sys
          sudo umount -l /tmp/archlinux/proc

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: mangohud-rootfs-${{ github.event.inputs.inputCustomTag }}
          draft: false
          prerelease: false
          tag_name: mangohud-rootfs-${{ github.event.inputs.inputCustomTag }}
          body: |
            MangoHud RootFS Build
            Version Information:
            - MangoHud: ${{ github.event.inputs.inputMangoHudVersion }}
            - Commit: ${{ github.event.inputs.inputMangoHudCommit }}
            - Custom Tag: ${{ github.event.inputs.inputCustomTag }}
            
            This rootfs contains a custom build of MangoHud for Winlator.
          files: |
            /tmp/archlinux/tmp/output/mangohud-output-lite.tar.xz
            /tmp/archlinux/tmp/output/mangohud-output-full.tar.xz
            /tmp/archlinux/tmp/output/mangohud-rootfs.tzst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          sudo rm -rf /tmp/archlinux