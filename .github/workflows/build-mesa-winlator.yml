# build-mesa-winlator.yml
name: Build Mesa Winlator (aarch64 only)

on:
  workflow_dispatch:
    inputs:
      mesa_branch:
        description: 'Mesa åˆ†æ”¯/æ ‡ç­¾/æäº¤ (ä¾‹å¦‚: main, 24.3, 24.4.0, adreno-main)'
        required: false
        default: 'adreno-main'
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
    - name: è®¾ç½®æ„å»ºå‚æ•°
      id: setup
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "MESA_BRANCH=${{ github.event.inputs.mesa_branch || 'gen8' }}" >> $GITHUB_ENV
        else
          echo "MESA_BRANCH=gen8" >> $GITHUB_ENV
        fi
        
        BUILD_DATE=$(date +%Y%m%d)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        echo "INSTALL_PREFIX=/data/data/com.winlator/files/imagefs/usr" >> $GITHUB_ENV
        
        echo "ä½¿ç”¨çš„ Mesa åˆ†æ”¯/æ ‡ç­¾: $MESA_BRANCH"
        echo "å®‰è£…ç›®å½•: $INSTALL_PREFIX"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "æ„å»ºç¯å¢ƒä¿¡æ¯:"
        uname -a
        lscpu | grep -E 'Model name|Architecture|CPU MHz|Core'
        free -h
        echo "å½“å‰æ¶æ„: $(uname -m)"
        echo "ç›®æ ‡æ¶æ„: aarch64"

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.list.d/ubuntu.sources
        sudo apt update
        sudo apt install -y \
          glslang-tools libxrandr-dev libxxf86vm-dev libxcb-shm0-dev libxcb-glx0-dev \
          libxext-dev llvm-19 libx11-dev libx11-xcb-dev libxcb1-dev libxcb-dri3-dev \
          libxcb-present-dev libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev \
          libxshmfence-dev libdrm-dev libgbm-dev libegl1-mesa-dev libexpat1-dev \
          python3-pip python3-setuptools python3-wheel ninja-build \
          pulseaudio libasound2-plugins wget unzip cmake git \
          flex bison libtool libclc-20-dev pkg-config build-essential libatomic1 \
          gcc g++ make cmake
        
        echo "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: å®‰è£… Python æ„å»ºå·¥å…·
      run: |
        sudo pip3 install meson mako
        echo "æ£€æŸ¥å®‰è£…çš„ meson ç‰ˆæœ¬:"
        meson --version
        python3 -c "import mesonbuild; print('mesonbuild æ¨¡å—è·¯å¾„:', mesonbuild.__file__)"
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: å…‹éš† Mesa æºç 
      run: |
        echo "ğŸ“¥ å…‹éš† Mesa ä»“åº“..."
        git clone https://github.com/lfdevs/mesa-for-android-container.git mesa
        cd mesa
        
        if [ -n "$MESA_BRANCH" ] && [ "$MESA_BRANCH" != "main" ]; then
          echo "æ£€å‡ºåˆ†æ”¯: $MESA_BRANCH"
          git checkout $MESA_BRANCH
        fi
        
        GIT_HASH=$(git rev-parse --short HEAD)
        if [ -f "VERSION" ]; then
          OFFICIAL_VERSION=$(cat VERSION)
        else
          OFFICIAL_VERSION="git-$GIT_HASH"
        fi
        
        GIT_DESCRIBE=$(git describe --tags --always 2>/dev/null || echo "custom-$GIT_HASH")
        
        echo "MESA_GIT_HASH=$GIT_HASH" >> $GITHUB_ENV
        echo "MESA_VERSION=$OFFICIAL_VERSION" >> $GITHUB_ENV
        echo "GIT_DESCRIBE=$GIT_DESCRIBE" >> $GITHUB_ENV
        echo "MESA_BRANCH_ACTUAL=$(git branch --show-current)" >> $GITHUB_ENV
        
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        echo "ç‰ˆæœ¬: $OFFICIAL_VERSION"
        echo "æäº¤: $GIT_HASH"
        echo "æè¿°: $GIT_DESCRIBE"

    # ==================== å…³é”®ä¿®å¤éƒ¨åˆ† ====================
    - name: åº”ç”¨ winlator x11 è¡¥ä¸ï¼ˆå¸¦ä¿æŠ¤å’ŒéªŒè¯ï¼‰
      run: |
        echo "=== å¼€å§‹åº”ç”¨è¡¥ä¸ ==="
        cd mesa

        # å¤‡ä»½åŸå§‹æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f src/vulkan/wsi/wsi_common_x11.c ]; then
          cp src/vulkan/wsi/wsi_common_x11.c src/vulkan/wsi/wsi_common_x11.c.bak
        fi

        # ä¸‹è½½è¡¥ä¸æ–‡ä»¶
        echo "ä¸‹è½½è¡¥ä¸æ–‡ä»¶..."
        wget -O wsi_common_x11.c.new https://github.com/afeimod/linbox/raw/main/path/wsi_common_x11.c
        if [ ! -f wsi_common_x11.c.new ]; then
          echo "é”™è¯¯ï¼šè¡¥ä¸ä¸‹è½½å¤±è´¥"
          exit 1
        fi

        # æ›¿æ¢åŸæ–‡ä»¶
        echo "æ›¿æ¢æ–‡ä»¶..."
        mv wsi_common_x11.c.new src/vulkan/wsi/wsi_common_x11.c
        if [ ! -f src/vulkan/wsi/wsi_common_x11.c ]; then
          echo "é”™è¯¯ï¼šç§»åŠ¨æ–‡ä»¶å¤±è´¥"
          exit 1
        fi

        # è®¾ç½®åªè¯»æƒé™ï¼Œé˜²æ­¢æ„å¤–ä¿®æ”¹
        echo "è®¾ç½®æ–‡ä»¶æƒé™ä¸ºåªè¯» (444)..."
        chmod 444 src/vulkan/wsi/wsi_common_x11.c

        # è®¡ç®—å¹¶ä¿å­˜æ–‡ä»¶å“ˆå¸Œï¼Œç”¨äºåç»­éªŒè¯
        sha256sum src/vulkan/wsi/wsi_common_x11.c > /tmp/wsi_common.hash
        echo "è¡¥ä¸æ–‡ä»¶å“ˆå¸Œå·²ä¿å­˜"

        echo "=== è¡¥ä¸åº”ç”¨å®Œæˆ ==="

    - name: æ„å»º aarch64 æ¶æ„ï¼ˆå¸¦è¡¥ä¸éªŒè¯ï¼‰
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»º aarch64 æ¶æ„..."
        cd mesa

        # éªŒè¯è¡¥ä¸æ–‡ä»¶æ˜¯å¦ä»ä¸ºé¢„æœŸå†…å®¹ï¼ˆæœªè¢«æ¢å¤ï¼‰
        echo "éªŒè¯è¡¥ä¸æ–‡ä»¶å®Œæ•´æ€§..."
        if ! sha256sum -c /tmp/wsi_common.hash; then
          echo "âš ï¸ è­¦å‘Šï¼šè¡¥ä¸æ–‡ä»¶å·²è¢«ä¿®æ”¹æˆ–æ¢å¤ï¼Œé‡æ–°åº”ç”¨è¡¥ä¸..."
          
          # é‡æ–°ä¸‹è½½è¡¥ä¸
          wget -O src/vulkan/wsi/wsi_common_x11.c https://github.com/afeimod/linbox/raw/main/path/wsi_common_x11.c
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯ï¼šé‡æ–°ä¸‹è½½è¡¥ä¸å¤±è´¥"
            exit 1
          fi
          
          # é‡æ–°è®¾ç½®åªè¯»æƒé™
          chmod 444 src/vulkan/wsi/wsi_common_x11.c
          
          # æ›´æ–°å“ˆå¸Œè®°å½•
          sha256sum src/vulkan/wsi/wsi_common_x11.c > /tmp/wsi_common.hash
          echo "è¡¥ä¸å·²é‡æ–°åº”ç”¨"
        else
          echo "âœ… è¡¥ä¸æ–‡ä»¶å®Œå¥½ï¼Œç»§ç»­æ„å»º"
        fi

        # åˆ›å»ºå®‰è£…ç›®å½•
        sudo mkdir -p $INSTALL_PREFIX
        sudo chmod 777 -R /data/data/com.winlator/files/imagefs

        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build-aarch64

        # é…ç½® aarch64 æ„å»º
        meson setup build-aarch64 \
           --prefix=/data/data/com.winlator/files/imagefs/usr \
           -Dplatforms=x11 \
           -Dbuildtype=release \
           -Degl-native-platform=x11 \
           -Dgallium-drivers=freedreno,zink \
           -Dvulkan-drivers=freedreno \
           -Dfreedreno-kmds=kgsl \
           -Dshader-cache=enabled \
           -Dgles1=enabled \
           -Dgles2=enabled \
           -Dopengl=true \
           -Dgbm=enabled \
           -Dglx=dri \
           -Degl=enabled \
           -Dglvnd=disabled \
           -Dmicrosoft-clc=disabled \
           -Dllvm=enabled \
           -Dshared-llvm=enabled \
           -Dvulkan-beta=true \
           -Dvideo-codecs=all

        echo "ğŸ—ï¸  æ­£åœ¨æ„å»º aarch64..."
        ninja -C build-aarch64 -j$(nproc)

        echo "ğŸ“¦ æ­£åœ¨å®‰è£… aarch64..."
        sudo ninja -C build-aarch64 install

        # éªŒè¯å®‰è£…
        echo "aarch64 å®‰è£…éªŒè¯:"
        ls -la $INSTALL_PREFIX/lib/
        file $INSTALL_PREFIX/lib/*.so 2>/dev/null | head -5 || true

    - name: æ‰“åŒ…æ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
        PACKAGE_NAME="rootfsmesa-${MESA_VERSION}-aarch64"
        ARCH_DESC="aarch64"
        
        cd /data/data/com.winlator/files/imagefs
        tar -czvf "${HOME}/${PACKAGE_NAME}-full.tar.gz" usr/
        
        cd $GITHUB_WORKSPACE
        mv "${HOME}/${PACKAGE_NAME}-full.tar.gz" .
        sha256sum ${PACKAGE_NAME}-*.tar.gz > checksums.txt
        
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "FULL_PACKAGE=${PACKAGE_NAME}-full.tar.gz" >> $GITHUB_ENV
        echo "ARCH_DESC=${ARCH_DESC}" >> $GITHUB_ENV
        
        echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ:"
        ls -lh *.tar.gz

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: rootfsmesa-${{ env.MESA_VERSION }}-aarch64
        path: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt

    - name: åˆ›å»ºè½»é‡çº§å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      if: ${{ github.event_name == 'workflow_dispatch' }}
      with:
        tag_name: rootfsmesa-${{ env.MESA_VERSION }}-aarch64-${{ env.BUILD_DATE }}
        name: Mesa rootfs ${{ env.MESA_VERSION }} (aarch64)
        body: |
          Mesa 3D Graphics Library for Android Container rootfs (Winlator å…¼å®¹)
          
          æ„å»ºä¿¡æ¯:
          - **ç‰ˆæœ¬**: ${{ env.MESA_VERSION }}
          - **æ¶æ„**: aarch64
          - **Git æè¿°**: ${{ env.GIT_DESCRIBE }}
          - **æäº¤å“ˆå¸Œ**: ${{ env.MESA_GIT_HASH }}
          - **æ„å»ºæ—¥æœŸ**: ${{ env.BUILD_DATE }}
          - **åˆ†æ”¯**: ${{ env.MESA_BRANCH }}
          - **æºç ä»“åº“**: lfdevs/mesa-for-android-container.git
          
          åŒ…å«æ–‡ä»¶:
          - `${{ env.FULL_PACKAGE }}` - å®Œæ•´ Mesa å®‰è£…åŒ…
          - `checksums.txt` - æ ¡éªŒå’Œæ–‡ä»¶
          
          ç›®å½•ç»“æ„:
          ```
          usr/
          â”œâ”€â”€ bin/                 # å¯æ‰§è¡Œæ–‡ä»¶
          â”œâ”€â”€ include/             # å¤´æ–‡ä»¶
          â”œâ”€â”€ lib/                 # aarch64 åº“ç›®å½•
          â”‚   â””â”€â”€ dri/             # DRI é©±åŠ¨
          â””â”€â”€ share/               # å…±äº«æ•°æ®
          ```
          
          å®‰è£…è¯´æ˜:
          1. ä¸‹è½½å®Œæ•´çš„ tar.gz åŒ…
          2. åœ¨ Android Container ç¯å¢ƒä¸­è§£å‹åˆ°æ ¹ç›®å½•: `tar -xzf package.tar.gz -C /`
          
          ä½¿ç”¨è¯´æ˜:
          ```bash
          export LD_LIBRARY_PATH=/data/data/com.winlator/files/imagefs/usr/lib:/data/data/com.winlator/files/imagefs/usr/lib/dri:$LD_LIBRARY_PATH
          export LIBGL_DRIVERS_PATH=/data/data/com.winlator/files/imagefs/usr/lib/dri
          ```
          
          é©±åŠ¨æ”¯æŒ:
          - **aarch64**:
            - âœ“ Gallium: freedreno, zink, llvmpipe
            - âœ“ Vulkan: freedreno
            - âœ“ OpenGL, OpenGL ES 1.x/2.x
            - âœ“ EGL, GBM
            - âœ“ X11 å¹³å°æ”¯æŒ
            - âœ“ è§†é¢‘ç¼–è§£ç å™¨æ”¯æŒ
          
          æ³¨æ„:
          - ä¸“ä¸º Android Container ç¯å¢ƒ (å¦‚ Winlator) ä¼˜åŒ–
          - éœ€è¦ rootfs ç¯å¢ƒ
          - å·²ç¦ç”¨ Wayland æ”¯æŒ
          - åŸºäº lfdevs/mesa-for-android-container ä»“åº“æ„å»ºï¼Œé’ˆå¯¹ Android ç¯å¢ƒè¿›è¡Œäº†ä¼˜åŒ–
        files: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: è¾“å‡ºæ€»ç»“
      run: |
        echo "âœ… Mesa rootfs æ„å»ºå®Œæˆ!"
        echo "================================"
        echo "ç‰ˆæœ¬: $MESA_VERSION"
        echo "æäº¤: $MESA_GIT_HASH"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
        echo "åˆ†æ”¯: $MESA_BRANCH"
        echo "ç›®æ ‡æ¶æ„: aarch64"
        echo "ç¯å¢ƒ: Android Container (Winlator å…¼å®¹)"
        echo ""
        echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -1 *.tar.gz | while read file; do
          echo "  - $file"
        done
        echo ""
        
        echo "aarch64 æ¶æ„æ”¯æŒ:"
        echo "  âœ“ Gallium: freedreno, zink, llvmpipe"
        echo "  âœ“ Vulkan: freedreno"
        echo "  âœ“ OpenGL, OpenGL ES 1.x/2.x"
        echo "  âœ“ EGL, GBM"
        echo "  âœ“ X11 å¹³å°æ”¯æŒ"
        echo "  âœ“ è§†é¢‘ç¼–è§£ç å™¨æ”¯æŒ"
        echo ""
        
        echo "å®‰è£…ç›®å½•ç»“æ„:"
        echo "  /data/data/com.winlator/files/imagefs/usr/lib/    - åº“æ–‡ä»¶"
        echo "  /data/data/com.winlator/files/imagefs/usr/lib/dri - DRI é©±åŠ¨"
        echo "  /data/data/com.winlator/files/imagefs/usr/bin/    - å¯æ‰§è¡Œæ–‡ä»¶"