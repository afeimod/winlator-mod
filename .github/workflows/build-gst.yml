name: winlator GStreamer Decoders (aarch64, Dev) - å®Œæ•´ä¿®å¤ç‰ˆ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'
  pull_request:

permissions:
  contents: write
  packages: write

env:
  LAST_COMMIT_FILE: last_gst_commit.txt
  INSTALL_ROOT: /data/data/com.winlator/files/rootfs/usr

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps: 
      # ğŸ§© æ£€å‡ºä»“åº“
      - name: æ£€å‡º workflow ä»“åº“
        uses: actions/checkout@v4

      # ğŸ“¦ å®‰è£…åŸºç¡€ä¾èµ–
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-pip git pkg-config \
            libglib2.0-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            liborc-0.4-dev libxv-dev libx11-dev libasound2-dev libpulse-dev patchelf \
            libtheora-dev libx264-dev libx265-dev libvpx-dev

      # âš™ï¸ å‡çº§ Meson å’Œ Ninja
      - name: å‡çº§ Meson å’Œ Ninja
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja

      # ğŸ§¬ å…‹éš† GStreamer å¼€å‘ç‰ˆæœ¬
      - name: å…‹éš† GStreamer å¼€å‘ç‰ˆæœ¬
        run: git clone --depth=1 https://gitlab.freedesktop.org/gstreamer/gstreamer.git

      # ğŸ” è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
      - name: è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
        id: get_dev_info
        run: |
          cd gstreamer
          LATEST_COMMIT=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          COMMIT_DATE=$(git log -1 --pretty=format:'%cd' --date=short)
          VERSION=$(sed -n '2p' "meson.build" | grep -oP "version\\s*:\\s*'\\K[^']+")
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "BUILD_DATE=$DATE" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV

      # ğŸ’¾ è·å–ä¸Šæ¬¡æ„å»ºæäº¤
      - name: è·å–ä¸Šæ¬¡æ„å»ºæäº¤
        id: get_last_commit
        run: |
          FILE=${{ env.LAST_COMMIT_FILE }}
          if [ -f "$FILE" ]; then
            LAST_COMMIT=$(cat "$FILE")
          else
            echo "none" > "$FILE"
            LAST_COMMIT="none"
          fi
          echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV

      # ğŸ” åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "skip_build=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ æäº¤æœªæ›´æ–°ï¼Œè·³è¿‡æ„å»ºã€‚"
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°æ–°æäº¤: $LATEST_COMMIT"
          fi

      # â­ï¸ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: |
          echo "ğŸŸ¡ ä»£ç æ— æ›´æ–°ï¼Œè·³è¿‡æ„å»ºæµç¨‹"
          exit 0

      # ğŸ” å‡†å¤‡å®‰è£…ç›®å½•æƒé™
      - name: å‡†å¤‡å®‰è£…ç›®å½•æƒé™
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ” å‡†å¤‡å®‰è£…ç›®å½•æƒé™..."
          WINLATOR_ROOT="/data/data/com.winlator/files/rootfs"
          
          # åˆ›å»ºå®Œæ•´çš„ç›®å½•ç»“æ„
          sudo mkdir -p $WINLATOR_ROOT/usr/{lib,include,bin,share}
          sudo mkdir -p $WINLATOR_ROOT/lib
          
          # è®¾ç½®æ­£ç¡®çš„æ‰€æœ‰æƒå’Œæƒé™
          sudo chown -R $USER:$USER $WINLATOR_ROOT
          sudo chmod -R 755 $WINLATOR_ROOT
          
          # éªŒè¯æƒé™
          echo "ğŸ“ ç›®å½•æƒé™:"
          ls -la $WINLATOR_ROOT/
          ls -la $WINLATOR_ROOT/usr/
          echo "âœ… å®‰è£…ç›®å½•æƒé™è®¾ç½®å®Œæˆ"

      # ğŸ”§ è®¾ç½® Winlator ç¼–è¯‘ç¯å¢ƒ
      - name: è®¾ç½® Winlator ç¼–è¯‘ç¯å¢ƒ
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          WINLATOR_ROOT="/data/data/com.winlator/files/rootfs"
          WINLATOR_LIB="${WINLATOR_ROOT}/usr/lib"
          WINLATOR_INC="${WINLATOR_ROOT}/usr/include"

          # ä½¿ç”¨æ··åˆè·¯å¾„æ ¼å¼çš„RPATH
          MIXED_RPATH='/data/data/com.winlator/files/rootfs/lib:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/pbutils:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/video:$ORIGIN/../../../gstreamer/libs/gst/base:$ORIGIN/../../../gstreamer/gst:$ORIGIN/../../../glib-2.82.2/glib:$ORIGIN/../../../glib-2.82.2/gobject:$ORIGIN/../../../libffi/src:$ORIGIN/../../../glib-2.82.2/gmodule:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/audio:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/tag:/data/data/com.winlator/files/rootfs/usr/lib'

          echo "LDFLAGS='-L${WINLATOR_LIB} -Wl,--dynamic-linker=${WINLATOR_LIB}/ld-linux-aarch64.so.1 -Wl,-rpath=${MIXED_RPATH}'" >> $GITHUB_ENV
          echo "CFLAGS='-I${WINLATOR_INC}'" >> $GITHUB_ENV
          echo "CXXFLAGS='-I${WINLATOR_INC}'" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH='${WINLATOR_LIB}:\$LD_LIBRARY_PATH'" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH='${WINLATOR_LIB}/pkgconfig:${WINLATOR_LIB}/aarch64-linux-gnu/pkgconfig:\$PKG_CONFIG_PATH'" >> $GITHUB_ENV
          echo "MIXED_RPATH=${MIXED_RPATH}" >> $GITHUB_ENV

          echo "âœ… å·²è®¾ç½®æ··åˆè·¯å¾„æ ¼å¼çš„ Winlator ç¯å¢ƒå˜é‡"

      # ğŸ“¦ ä½¿ç”¨ç³»ç»Ÿ libvpx åº“ï¼ˆä¿®å¤æƒé™é—®é¢˜ï¼‰
      - name: å¤åˆ¶ç³»ç»Ÿ libvpx åº“
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ“¦ å¤åˆ¶ç³»ç»Ÿ libvpx åº“..."
          
          # é¦–å…ˆä¿®å¤ç›®æ ‡ç›®å½•çš„æƒé™
          WINLATOR_ROOT="/data/data/com.winlator/files/rootfs"
          sudo chown -R $USER:$USER $WINLATOR_ROOT
          sudo chmod -R 755 $WINLATOR_ROOT
          
          # æŸ¥æ‰¾ç³»ç»Ÿ libvpx åº“æ–‡ä»¶
          LIBVPX_LIBS=$(find /usr/lib -name "libvpx*.so*" 2>/dev/null || true)
          if [ -z "$LIBVPX_LIBS" ]; then
            LIBVPX_LIBS=$(find /usr/lib/aarch64-linux-gnu -name "libvpx*.so*" 2>/dev/null || true)
          fi
          
          if [ -n "$LIBVPX_LIBS" ]; then
            echo "âœ… æ‰¾åˆ°ç³»ç»Ÿ libvpx åº“:"
            echo "$LIBVPX_LIBS"
            
            # å¤åˆ¶åº“æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•ï¼ˆä¸ä½¿ç”¨sudoï¼‰
            for lib in $LIBVPX_LIBS; do
              if [ -f "$lib" ]; then
                cp -p "$lib" "/data/data/com.winlator/files/rootfs/usr/lib/"
                echo "ğŸ“„ å¤åˆ¶: $(basename $lib)"
              fi
            done
            
            # å¤åˆ¶å¤´æ–‡ä»¶ï¼ˆä¸ä½¿ç”¨sudoï¼‰
            if [ -d "/usr/include/aarch64-linux-gnu/vpx" ]; then
              cp -r "/usr/include/aarch64-linux-gnu/vpx" "/data/data/com.winlator/files/rootfs/usr/include/"
            elif [ -d "/usr/include/vpx" ]; then
              cp -r "/usr/include/vpx" "/data/data/com.winlator/files/rootfs/usr/include/"
            fi
            
            # ä¿®å¤å¤åˆ¶æ–‡ä»¶çš„æƒé™ï¼ˆä¸ä½¿ç”¨sudoï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æ˜¯æ‰€æœ‰è€…ï¼‰
            chmod 755 /data/data/com.winlator/files/rootfs/usr/lib/libvpx*.so* || true
            chmod -R 644 /data/data/com.winlator/files/rootfs/usr/include/vpx/* || true
            chmod 755 /data/data/com.winlator/files/rootfs/usr/include/vpx || true
            
            echo "âœ… ç³»ç»Ÿ libvpx åº“å¤åˆ¶å®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç³»ç»Ÿ libvpx åº“ï¼ŒGStreamer å°†ä¸åŒ…å« VP8/VP9 è§£ç æ”¯æŒ"
          fi

      # ğŸ› ï¸ æ„å»º GStreamer è§£ç å™¨
      - name: æ„å»º GStreamer è§£ç å™¨
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»º GStreamer..."
          cd gstreamer
          git submodule update --init --recursive
          
          # å†æ¬¡ç¡®ä¿æƒé™æ­£ç¡®
          WINLATOR_ROOT="/data/data/com.winlator/files/rootfs"
          chmod -R 755 $WINLATOR_ROOT
          
          # æ£€æŸ¥ libvpx æ˜¯å¦å¯ç”¨
          if [ -f "/data/data/com.winlator/files/rootfs/usr/lib/libvpx.so" ] || \
             [ -f "/data/data/com.winlator/files/rootfs/usr/lib/libvpx.so.8" ] || \
             [ -f "/data/data/com.winlator/files/rootfs/usr/lib/libvpx.so.7" ]; then
            echo "âœ… libvpx å¯ç”¨ï¼Œå¯ç”¨ VP8/VP9 æ”¯æŒ"
            VPX_OPTION="-Dgst-plugins-good:vpx=enabled"
          else
            echo "âš ï¸ libvpx ä¸å¯ç”¨ï¼Œç¦ç”¨ VP8/VP9 æ”¯æŒ"
            VPX_OPTION="-Dgst-plugins-good:vpx=disabled"
          fi
          
          # åˆ›å»ºä¸´æ—¶å®‰è£…ç›®å½•
          TEMP_INSTALL_DIR="/tmp/gst-install"
          mkdir -p $TEMP_INSTALL_DIR
          
          echo "âš™ï¸ é…ç½® GStreamer æ„å»º..."
          meson setup build \
            -Dprefix=/usr \
            --libdir=lib \
            -Dbase=enabled \
            -Dgood=enabled -Dugly=enabled -Dbad=enabled \
            -Dlibav=enabled -Dgpl=enabled -Ddefault_library=shared \
            -Dtests=disabled -Ddoc=disabled -Dexamples=disabled \
            -Dpython=disabled -Dnls=disabled \
            -Dgst-plugins-libav:aac=disabled \
            $VPX_OPTION \
            -Dgst-plugins-bad:hip=disabled -Dgst-plugins-bad:nvcodec=disabled \
            -Dgst-plugins-base:gl=disabled -Dintrospection=disabled \
            -Dgst-full=enabled \
            -Ddevtools=disabled -Dtools=disabled -Drtsp_server=disabled \
            -Dbuildtype=release
          
          echo "ğŸ”¨ ç¼–è¯‘ GStreamer..."
          ninja -C build -j$(nproc)
          
          echo "ğŸ“¥ å®‰è£… GStreamer åˆ°ä¸´æ—¶ç›®å½•..."
          DESTDIR="$TEMP_INSTALL_DIR" ninja -C build install
          
          echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä½ç½®..."
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ° Winlator ç›®å½•
          cp -r $TEMP_INSTALL_DIR/usr/* $WINLATOR_ROOT/usr/
          
          # ä¿®å¤æ–‡ä»¶æƒé™ï¼ˆé¿å…æƒé™é”™è¯¯ï¼‰
          echo "ğŸ”§ ä¿®å¤æ–‡ä»¶æƒé™..."
          find $WINLATOR_ROOT/usr -type f -exec chmod 644 {} \; 2>/dev/null || true
          find $WINLATOR_ROOT/usr -type d -exec chmod 755 {} \; 2>/dev/null || true
          find $WINLATOR_ROOT/usr/bin -type f -exec chmod 755 {} \; 2>/dev/null || true
          find $WINLATOR_ROOT/usr/lib -name "*.so*" -exec chmod 755 {} \; 2>/dev/null || true
          
          # ç‰¹åˆ«ä¿®å¤ libvpx æ–‡ä»¶çš„æƒé™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          chmod 755 $WINLATOR_ROOT/usr/lib/libvpx*.so* 2>/dev/null || true
          chmod -R 644 $WINLATOR_ROOT/usr/include/vpx/* 2>/dev/null || true
          chmod 755 $WINLATOR_ROOT/usr/include/vpx 2>/dev/null || true
          
          echo "âœ… GStreamer æ„å»ºå®Œæˆ"

      # ğŸ”§ ä¿®æ­£ ELF æ–‡ä»¶ RPATHï¼ˆä½¿ç”¨æ··åˆè·¯å¾„æ ¼å¼ï¼‰
      - name: ä¿®æ­£ ELF æ–‡ä»¶ RPATHï¼ˆæ··åˆè·¯å¾„æ ¼å¼ï¼‰
        if: steps.check_build.outputs.skip_build == 'false'
        shell: bash
        run: |
          echo "ğŸ”§ å¼€å§‹ä¿®æ­£ ELF æ–‡ä»¶ RPATHï¼ˆæ··åˆè·¯å¾„æ ¼å¼ï¼‰..."
          WINLATOR_ROOT="/data/data/com.winlator/files/rootfs"
          WINLATOR_LIB="${WINLATOR_ROOT}/usr/lib"
          GST_PLUGINS_PATH="${WINLATOR_LIB}/gstreamer-1.0"

          # ä½¿ç”¨æ··åˆè·¯å¾„æ ¼å¼çš„RPATH
          MIXED_RPATH='/data/data/com.winlator/files/rootfs/lib:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/pbutils:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/video:$ORIGIN/../../../gstreamer/libs/gst/base:$ORIGIN/../../../gstreamer/gst:$ORIGIN/../../../glib-2.82.2/glib:$ORIGIN/../../../glib-2.82.2/gobject:$ORIGIN/../../../libffi/src:$ORIGIN/../../../glib-2.82.2/gmodule:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/audio:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/tag:/data/data/com.winlator/files/rootfs/usr/lib'

          echo "ğŸ“¦ æ‰«æåŠ¨æ€ ELF æ–‡ä»¶ä¸­..."
          FILES=$(find "$WINLATOR_LIB" -type f -name "*.so*" | while read -r f; do
              if file "$f" | grep -q "ELF"; then
                  if readelf -l "$f" 2>/dev/null | grep -q 'INTERP'; then
                      echo "$f"
                  fi
              fi
          done)
          TOTAL=$(echo "$FILES" | grep -c . || true)
          echo "ğŸ“Š æ£€æµ‹åˆ° $TOTAL ä¸ªåŠ¨æ€ ELF æ–‡ä»¶"

          [ "$TOTAL" -eq 0 ] && echo "âš ï¸ æœªæ‰¾åˆ°å¯ä¿®æ­£çš„åŠ¨æ€ ELF æ–‡ä»¶ï¼Œè·³è¿‡" && exit 0

          # åˆ›å»ºä¿®æ­£è„šæœ¬
          FIX_SCRIPT=$(mktemp)
          cat <<'EOF' > "$FIX_SCRIPT"
          f="$1"; MIXED_RPATH="$2"; WINLATOR_LIB="$3"
          echo "ğŸ”§ ä¿®æ­£ $f"
          
          # é¦–å…ˆç§»é™¤ç°æœ‰çš„RPATH
          patchelf --remove-rpath "$f" 2>/dev/null || true
          
          # è®¾ç½®æ··åˆè·¯å¾„æ ¼å¼çš„RPATH
          patchelf --set-rpath "$MIXED_RPATH" "$f" 2>/dev/null || true
          
          # è®¾ç½®åŠ¨æ€é“¾æ¥å™¨
          patchelf --set-interpreter "${WINLATOR_LIB}/ld-linux-aarch64.so.1" "$f" 2>/dev/null || true
          
          # éªŒè¯è®¾ç½®
          echo "âœ… éªŒè¯ $f çš„RPATH:"
          patchelf --print-rpath "$f" 2>/dev/null || echo "æ— æ³•è¯»å–RPATH"
          EOF
          
          chmod +x "$FIX_SCRIPT"
          
          # ç‰¹åˆ«å¤„ç†å…³é”®åº“æ–‡ä»¶
          echo "ğŸ”§ ç‰¹åˆ«å¤„ç†å…³é”®åº“æ–‡ä»¶..."
          for lib in "libgstpbutils-1.0.so.0" "libgstreamer-1.0.so.0" "libgsttag-1.0.so.0" "libglib-2.0.so.0" "libgobject-2.0.so.0" "libgstapetag.so"; do
              LIB_PATH=$(find "$WINLATOR_LIB" -name "$lib" | head -1)
              if [ -n "$LIB_PATH" ]; then
                  echo "ğŸ¯ å¤„ç†å…³é”®åº“: $lib"
                  bash "$FIX_SCRIPT" "$LIB_PATH" "$MIXED_RPATH" "$WINLATOR_LIB"
              else
                  echo "âš ï¸ æœªæ‰¾åˆ°åº“: $lib"
              fi
          done
          
          # å¤„ç†å‰10ä¸ªæ–‡ä»¶å¹¶æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
          echo "ğŸ” å¤„ç†å‰10ä¸ªæ–‡ä»¶ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰:"
          echo "$FILES" | head -10 | while read f; do
              bash "$FIX_SCRIPT" "$f" "$MIXED_RPATH" "$WINLATOR_LIB"
          done
          
          # æ‰¹é‡å¤„ç†å‰©ä½™æ–‡ä»¶ï¼ˆé™é»˜æ¨¡å¼ï¼‰
          if [ "$TOTAL" -gt 10 ]; then
              echo "âš¡ æ‰¹é‡å¤„ç†å‰©ä½™ $(($TOTAL - 10)) ä¸ªæ–‡ä»¶..."
              echo "$FILES" | tail -n +11 | xargs -P "$(nproc)" -I{} bash -c 'patchelf --remove-rpath "$1" 2>/dev/null || true; patchelf --set-rpath "$2" "$1" 2>/dev/null || true; patchelf --set-interpreter "$3/ld-linux-aarch64.so.1" "$1" 2>/dev/null || true' _ {} "$MIXED_RPATH" "$WINLATOR_LIB"
          fi
          
          echo "âœ… ELF æ–‡ä»¶ RPATH ä¿®æ­£å®Œæˆï¼ˆæ··åˆè·¯å¾„æ ¼å¼ï¼‰"
          
          # éªŒè¯å…³é”®æ–‡ä»¶çš„RPATH
          echo "ğŸ” éªŒè¯å…³é”®æ–‡ä»¶RPATH:"
          for lib in "libgstpbutils-1.0.so.0" "libgstreamer-1.0.so.0" "libgsttag-1.0.so.0" "libglib-2.0.so.0" "libgobject-2.0.so.0" "libgstapetag.so"; do
              LIB_PATH=$(find "$WINLATOR_LIB" -name "$lib" | head -1)
              if [ -n "$LIB_PATH" ]; then
                  echo "ğŸ“„ $lib:"
                  patchelf --print-rpath "$LIB_PATH" 2>/dev/null || echo "æ— æ³•è¯»å–RPATH"
              fi
          done

          # éªŒè¯æ’ä»¶ç›®å½•ä¸­çš„æ–‡ä»¶
          echo "ğŸ” éªŒè¯æ’ä»¶ç›®å½•RPATH:"
          find "$GST_PLUGINS_PATH" -name "*.so" | head -3 | while read f; do
              echo "ğŸ“„ $(basename $f):"
              patchelf --print-rpath "$f" 2>/dev/null || echo "æ— æ³•è¯»å–RPATH"
          done

      # ğŸ§ª éªŒè¯æ„å»ºç»“æœ
      - name: éªŒè¯æ„å»ºç»“æœ
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ§ª éªŒè¯æ„å»ºç»“æœ..."
          WINLATOR_LIB="/data/data/com.winlator/files/rootfs/usr/lib"
          GST_PLUGINS_PATH="/data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0"
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥å…³é”®æ–‡ä»¶:"
          [ -f "$WINLATOR_LIB/ld-linux-aarch64.so.1" ] && echo "âœ… åŠ¨æ€é“¾æ¥å™¨å­˜åœ¨" || echo "âŒ åŠ¨æ€é“¾æ¥å™¨ç¼ºå¤±"
          [ -f "$WINLATOR_LIB/gstreamer-1.0/gst-inspect-1.0" ] && echo "âœ… gst-inspect-1.0 å­˜åœ¨" || echo "âŒ gst-inspect-1.0 ç¼ºå¤±"
          [ -d "$GST_PLUGINS_PATH" ] && echo "âœ… GStreamer æ’ä»¶ç›®å½•å­˜åœ¨" || echo "âŒ GStreamer æ’ä»¶ç›®å½•ç¼ºå¤±"
          
          # æ£€æŸ¥å…³é”®åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          for lib in "libgstpbutils-1.0.so.0" "libgstreamer-1.0.so.0" "libgsttag-1.0.so.0" "libglib-2.0.so.0" "libgobject-2.0.so.0" "libgstapetag.so"; do
              if [ -f "$WINLATOR_LIB/$lib" ]; then
                  echo "âœ… $lib å­˜åœ¨"
              else
                  # å°è¯•æŸ¥æ‰¾å¸¦ç‰ˆæœ¬å·çš„åº“
                  FOUND=$(find "$WINLATOR_LIB" -name "$lib*" | head -1)
                  if [ -n "$FOUND" ]; then
                      echo "âœ… $lib å­˜åœ¨ (ä½œä¸º $(basename $FOUND))"
                  else
                      echo "âŒ $lib ç¼ºå¤±"
                  fi
              fi
          done
          
          # æ£€æŸ¥ libvpx æ˜¯å¦å­˜åœ¨
          if [ -f "$WINLATOR_LIB/libvpx.so" ] || [ -f "$WINLATOR_LIB/libvpx.so.8" ] || [ -f "$WINLATOR_LIB/libvpx.so.7" ] || [ -f "$WINLATOR_LIB/libvpx.so.9" ]; then
            echo "âœ… libvpx å­˜åœ¨"
            VPX_AVAILABLE=true
          else
            echo "âš ï¸ libvpx ä¸å­˜åœ¨ï¼ŒVP8/VP9 è§£ç ä¸å¯ç”¨"
            VPX_AVAILABLE=false
          fi
          
          # ç»Ÿè®¡æ’ä»¶æ•°é‡
          PLUGIN_COUNT=$(find "$GST_PLUGINS_PATH" -name "*.so" | wc -l)
          echo "ğŸ“Š GStreamer æ’ä»¶æ•°é‡: $PLUGIN_COUNT"
          
          # éªŒè¯gst-inspectèƒ½å¦è¿è¡Œ
          echo "ğŸ” æµ‹è¯• gst-inspect-1.0:"
          if [ -f "$WINLATOR_LIB/gstreamer-1.0/gst-inspect-1.0" ]; then
              $WINLATOR_LIB/ld-linux-aarch64.so.1 $WINLATOR_LIB/gstreamer-1.0/gst-inspect-1.0 --version && echo "âœ… gst-inspect ç‰ˆæœ¬æ£€æŸ¥æˆåŠŸ" || echo "âŒ gst-inspect ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          else
              echo "âš ï¸ gst-inspect-1.0 ä¸å­˜åœ¨ï¼Œè·³è¿‡æµ‹è¯•"
          fi
          
          # æ£€æŸ¥å…³é”®æ’ä»¶
          echo "ğŸ” æ£€æŸ¥å…³é”®æ’ä»¶:"
          for plugin in coreelements apetag; do
              if [ -f "$WINLATOR_LIB/gstreamer-1.0/gst-inspect-1.0" ]; then
                  if $WINLATOR_LIB/ld-linux-aarch64.so.1 $WINLATOR_LIB/gstreamer-1.0/gst-inspect-1.0 $plugin >/dev/null 2>&1; then
                      echo "âœ… æ’ä»¶ $plugin å¯ç”¨"
                  else
                      echo "âŒ æ’ä»¶ $plugin ä¸å¯ç”¨"
                  fi
              else
                  echo "âš ï¸ æ— æ³•æ£€æŸ¥æ’ä»¶ $plugin (gst-inspect ç¼ºå¤±)"
              fi
          done
          
          # å¦‚æœ libvpx å¯ç”¨ï¼Œæ£€æŸ¥ VP8/VP9 æ’ä»¶
          if [ "$VPX_AVAILABLE" = "true" ]; then
            for plugin in vp8dec vp9dec; do
                if [ -f "$WINLATOR_LIB/gstreamer-1.0/gst-inspect-1.0" ]; then
                    if $WINLATOR_LIB/ld-linux-aarch64.so.1 $WINLATOR_LIB/gstreamer-1.0/gst-inspect-1.0 $plugin >/dev/null 2>&1; then
                        echo "âœ… æ’ä»¶ $plugin å¯ç”¨"
                    else
                        echo "âŒ æ’ä»¶ $plugin ä¸å¯ç”¨"
                    fi
                else
                    echo "âš ï¸ æ— æ³•æ£€æŸ¥æ’ä»¶ $plugin (gst-inspect ç¼ºå¤±)"
                fi
            done
          fi

      # ğŸ§± æ‰“åŒ…æ„å»ºç»“æœ
      - name: æ‰“åŒ… usr ç›®å½•
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…æ„å»ºç»“æœ..."
          cd /data/data/com.winlator/files/rootfs
          TAR_NAME="winlator-gst-decoders-${VERSION}-mixed-rpath.tar.gz"
          
          # åˆ›å»ºæ‰“åŒ…åˆ—è¡¨ï¼Œæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶
          echo "ğŸ—‚ï¸ åˆ›å»ºæ‰“åŒ…æ¸…å•..."
          find usr -type f | head -10 > /tmp/file_list.txt
          echo "... (çœç•¥å…¶ä»–æ–‡ä»¶)" >> /tmp/file_list.txt
          echo "ğŸ“„ æ‰“åŒ…å‰æ–‡ä»¶åˆ—è¡¨æ ·æœ¬:"
          cat /tmp/file_list.txt
          
          # æ‰“åŒ…
          tar -czvf /home/runner/$TAR_NAME usr
          
          # è®°å½•æ„å»ºä¿¡æ¯
          echo "$LATEST_COMMIT" > ${{ env.LAST_COMMIT_FILE }}
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
          
          # æ˜¾ç¤ºæ‰“åŒ…ä¿¡æ¯
          echo "ğŸ“Š æ‰“åŒ…å®Œæˆ: $TAR_NAME"
          du -h /home/runner/$TAR_NAME

      # â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}
          retention-days: 30

      # ğŸ’¾ ä¸Šä¼ æäº¤è®°å½•
      - name: ä¸Šä¼ æäº¤è®°å½•
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: last-gst-commit
          path: ${{ env.LAST_COMMIT_FILE }}
          retention-days: 365

      # ğŸš€ å‘å¸ƒåˆ° GitHub Release
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}-mixed-rpath
          name: "GStreamer Decoders ${{ env.VERSION }} Mixed RPATH (aarch64, Winlator)"
          body: |
            ## ğŸ¯ GStreamer å¼€å‘ç‰ˆæœ¬æ„å»º - æ··åˆ RPATH æ ¼å¼

            ### ğŸ“‹ æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: `${{ env.VERSION }}`
            - **æ¶æ„**: aarch64
            - **ç¯å¢ƒ**: Winlator
            - **æäº¤**: [`${{ env.COMMIT_SHORT }}`](https://gitlab.freedesktop.org/gstreamer/gstreamer/-/commit/${{ env.LATEST_COMMIT }})
            - **æäº¤æ—¥æœŸ**: ${{ env.COMMIT_DATE }}
            - **ä½œè€…**: `${{ env.AUTHOR }}`
            - **æ„å»ºæ—¶é—´**: `${{ env.BUILD_DATE }}`

            ### ğŸ› ï¸ æ„å»ºç‰¹æ€§
            - âœ… Base / Good / Ugly / Bad / LibAV / GPL å…¨å¯ç”¨
            - âœ… VP8/VP9 è§£ç æ”¯æŒï¼šä½¿ç”¨ç³»ç»Ÿ libvpxï¼ˆå¦‚æœå¯ç”¨ï¼‰
            - âŒ RTSP Server å·²ç¦ç”¨
            - ğŸ—ï¸ æ„å»ºç±»å‹: Release
            - ğŸ”— RPATH: ä½¿ç”¨æ··åˆè·¯å¾„æ ¼å¼ï¼ˆç»å¯¹è·¯å¾„ + ç›¸å¯¹è·¯å¾„ï¼‰

            ### ğŸ”§ RPATH æ ¼å¼
            ```
            /data/data/com.winlator/files/rootfs/lib:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/pbutils:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/video:$ORIGIN/../../../gstreamer/libs/gst/base:$ORIGIN/../../../gstreamer/gst:$ORIGIN/../../../glib-2.82.2/glib:$ORIGIN/../../../glib-2.82.2/gobject:$ORIGIN/../../../libffi/src:$ORIGIN/../../../glib-2.82.2/gmodule:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/audio:$ORIGIN/../../../gst-plugins-base/gst-libs/gst/tag:/data/data/com.winlator/files/rootfs/usr/lib
            ```

            ### ğŸ“¦ æ–‡ä»¶ä¿¡æ¯
            - æ–‡ä»¶å: `${{ env.TAR_NAME }}`
            - åŠ¨æ€é“¾æ¥å™¨: `/data/data/com.winlator/files/rootfs/usr/lib/ld-linux-aarch64.so.1`
            - å®‰è£…è·¯å¾„: `/data/data/com.winlator/files/rootfs/usr`
            
            ### ğŸ“¥ å®‰è£…è¯´æ˜
            1. è§£å‹åˆ° Winlator çš„ rootfs ç›®å½•ï¼š
            ```bash
            tar -xzvf ${{ env.TAR_NAME }} -C /data/data/com.winlator/files/rootfs/
            ```
            
            ### ğŸ§ª æµ‹è¯•å‘½ä»¤
            ```bash
            # è®¾ç½®ç¯å¢ƒå˜é‡
            export LD_LIBRARY_PATH=/data/data/com.winlator/files/rootfs/usr/lib
            export PATH=/data/data/com.winlator/files/rootfs/usr/bin:$PATH
            
            # æµ‹è¯• GStreamer
            gst-inspect-1.0 --version
            gst-inspect-1.0 coreelements
            gst-inspect-1.0 vp8dec
            gst-inspect-1.0 vp9dec
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ“Š æ„å»ºæ€»ç»“
      - name: æ„å»ºæ€»ç»“
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆæ€»ç»“"
          echo "========================"
          echo "âœ… ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "âœ… æäº¤: ${{ env.COMMIT_SHORT }}"
          echo "âœ… æ–‡ä»¶: ${{ env.TAR_NAME }}"
          echo "âœ… æ—¶é—´: ${{ env.BUILD_DATE }}"
          echo "âœ… çŠ¶æ€: æ··åˆ RPATH æ ¼å¼å·²åº”ç”¨"
          echo "========================"
          echo "æ‰€æœ‰æ„å»ºæ­¥éª¤å·²å®Œæˆï¼"