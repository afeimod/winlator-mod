name: Build GStreamer Decoders (armv7, Dev + libvpx)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'
  pull_request:

permissions:
  contents: write
  packages: write
  actions: write
  checks: write

env:
  LAST_COMMIT_FILE: last_gst_commit.txt
  INSTALL_ROOT: /data/data/com.winlator/files/rootfs/usr
  CROSS_FILE: cross-file.txt
  NDK_VERSION: r25b
  NDK_DIR: /opt/android-ndk

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      # ğŸ§© æ£€å‡º workflow ä»“åº“
      - name: æ£€å‡º workflow ä»“åº“
        uses: actions/checkout@v4

      # ğŸ“¦ å®‰è£…åŸºç¡€ä¾èµ–
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-pip git pkg-config nasm \
            libglib2.0-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            liborc-0.4-dev libxv-dev libx11-dev libasound2-dev libpulse-dev patchelf \
            libtheora-dev libx264-dev libx265-dev libvpx-dev \
            wget unzip autoconf automake libtool

      # âš™ï¸ å‡çº§ Meson å’Œ Ninja
      - name: å‡çº§ Meson å’Œ Ninja
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja

      # ğŸ”§ å®‰è£… Android NDK
      - name: å®‰è£… Android NDK
        run: |
          echo "ğŸ“¦ ä¸‹è½½ Android NDK ${{ env.NDK_VERSION }}..."
          wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip
          sudo unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip -d /opt
          sudo mv /opt/android-ndk-${{ env.NDK_VERSION }} ${{ env.NDK_DIR }}
          echo "âœ… Android NDK å®‰è£…å®Œæˆ"

      # ğŸ“ åˆ›å»ºäº¤å‰ç¼–è¯‘é…ç½®æ–‡ä»¶
      - name: åˆ›å»ºäº¤å‰ç¼–è¯‘é…ç½®æ–‡ä»¶
        run: |
          cat > ${{ env.CROSS_FILE }} << 'EOF'
          [host_machine]
          system = 'linux'
          cpu_family = 'arm'
          cpu = 'armv7'
          endian = 'little'

          [properties]
          prefix = '/data/data/com.winlator/files/rootfs/usr'
          libdir = 'lib'
          pkg_config_libdir = '/data/data/com.winlator/files/rootfs/usr/lib/pkgconfig'

          [binaries]
          c = '${{ env.NDK_DIR }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang'
          cpp = '${{ env.NDK_DIR }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang++'
          ar = '${{ env.NDK_DIR }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '${{ env.NDK_DIR }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          pkgconfig = 'pkg-config'
          EOF

      # ğŸ§¬ å…‹éš† GStreamer å¼€å‘ç‰ˆæœ¬
      - name: å…‹éš† GStreamer å¼€å‘ç‰ˆæœ¬
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/gstreamer/gstreamer.git

      # ğŸ” è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
      - name: è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
        id: get_dev_info
        run: |
          cd gstreamer
          LATEST_COMMIT=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          COMMIT_DATE=$(git log -1 --pretty=format:'%cd' --date=short)
          VERSION=$(sed -n '2p' "meson.build" | grep -oP "version\\s*:\\s*'\\K[^']+")
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "BUILD_DATE=$DATE" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV

      # ğŸ’¾ è·å–ä¸Šæ¬¡æ„å»ºæäº¤
      - name: è·å–ä¸Šæ¬¡æ„å»ºæäº¤
        id: get_last_commit
        run: |
          FILE="$GITHUB_WORKSPACE/${{ env.LAST_COMMIT_FILE }}"
          if [ -f "$FILE" ]; then
            LAST_COMMIT=$(cat "$FILE")
          else
            echo "none" > "$FILE"
            LAST_COMMIT="none"
          fi
          echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV

      # ğŸ” åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "skip_build=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ æäº¤æœªæ›´æ–°ï¼Œè·³è¿‡æ„å»ºã€‚"
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°æ–°æäº¤: $LATEST_COMMIT"
          fi

      # â­ï¸ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: exit 0

      # ğŸ”¤ æ„å»º libiconv (å¿…éœ€)
      - name: æ„å»º libiconv
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ“¦ æ„å»º libiconv for Android..."
          wget -q https://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.17.tar.gz
          tar -xzf libiconv-1.17.tar.gz
          cd libiconv-1.17
          
          # è®¾ç½® Android NDK å·¥å…·é“¾è·¯å¾„
          export TOOLCHAIN=${{ env.NDK_DIR }}/toolchains/llvm/prebuilt/linux-x86_64
          export CC=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang
          export CXX=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang++
          export AR=$TOOLCHAIN/bin/llvm-ar
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          
          # ç¡®ä¿å®‰è£…ç›®å½•æƒé™æ­£ç¡®
          sudo mkdir -p ${{ env.INSTALL_ROOT }}
          sudo chown -R $USER:$USER ${{ env.INSTALL_ROOT }}
          
          # é…ç½®å’Œæ„å»º
          ./configure \
            --host=arm-linux-androideabi \
            --prefix=${{ env.INSTALL_ROOT }} \
            --enable-static=no \
            --enable-shared=yes \
            --disable-nls
          
          make -j$(nproc)
          make install
          echo "âœ… libiconv æ„å»ºå®Œæˆ"

      # ğŸ”¤ æ„å»º gettext (ä»…æ ¸å¿ƒåº“ï¼Œä¸æ„å»ºå·¥å…·)
      - name: æ„å»º gettext æ ¸å¿ƒåº“
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ“¦ æ„å»º gettext æ ¸å¿ƒåº“ for Android..."
          wget -q https://ftp.gnu.org/pub/gnu/gettext/gettext-0.21.tar.gz
          tar -xzf gettext-0.21.tar.gz
          cd gettext-0.21
          
          # è®¾ç½® Android NDK å·¥å…·é“¾è·¯å¾„
          export TOOLCHAIN=${{ env.NDK_DIR }}/toolchains/llvm/prebuilt/linux-x86_64
          export CC=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang
          export CXX=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang++
          export AR=$TOOLCHAIN/bin/llvm-ar
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          
          # ç¡®ä¿å®‰è£…ç›®å½•æƒé™æ­£ç¡®
          sudo mkdir -p ${{ env.INSTALL_ROOT }}
          sudo chown -R $USER:$USER ${{ env.INSTALL_ROOT }}
          
          # ä»…æ„å»ºæ ¸å¿ƒåº“ï¼Œè·³è¿‡å¤æ‚çš„å·¥å…·
          ./configure \
            --host=arm-linux-androideabi \
            --prefix=${{ env.INSTALL_ROOT }} \
            --enable-static=no \
            --enable-shared=yes \
            --disable-java \
            --disable-curses \
            --disable-acl \
            --disable-openmp \
            --disable-csharp \
            --disable-libasprintf \
            --disable-curses \
            --with-libiconv-prefix=${{ env.INSTALL_ROOT }} \
            --disable-rpath
          
          # ä»…æ„å»ºå’Œå®‰è£…æ ¸å¿ƒåº“
          cd gettext-runtime
          make -j$(nproc)
          make install
          echo "âœ… gettext æ ¸å¿ƒåº“æ„å»ºå®Œæˆ"

      # ğŸ”§ æ„å»º pixman (è§£å†³ cpu-features.h é—®é¢˜)
      - name: æ„å»º pixman
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ“¦ æ„å»º pixman for Android..."
          wget -q https://www.cairographics.org/releases/pixman-0.42.2.tar.gz
          tar -xzf pixman-0.42.2.tar.gz
          cd pixman-0.42.2
          
          # è®¾ç½® Android NDK å·¥å…·é“¾è·¯å¾„
          export TOOLCHAIN=${{ env.NDK_DIR }}/toolchains/llvm/prebuilt/linux-x86_64
          export CC=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang
          export CXX=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang++
          export AR=$TOOLCHAIN/bin/llvm-ar
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          
          # è®¾ç½®ç¼–è¯‘æ ‡å¿—
          export CFLAGS="-fPIC -march=armv7-a -mfpu=neon -mfloat-abi=softfp -I${{ env.INSTALL_ROOT }}/include"
          export LDFLAGS="-L${{ env.INSTALL_ROOT }}/lib"
          
          # ç¡®ä¿å®‰è£…ç›®å½•æƒé™æ­£ç¡®
          sudo mkdir -p ${{ env.INSTALL_ROOT }}
          sudo chown -R $USER:$USER ${{ env.INSTALL_ROOT }}
          
          # ç¦ç”¨ ARM ä¼˜åŒ–ä»¥é¿å… cpu-features.h ä¾èµ–
          ./configure \
            --host=arm-linux-androideabi \
            --prefix=${{ env.INSTALL_ROOT }} \
            --enable-static=no \
            --enable-shared=yes \
            --disable-arm-iwmmxt \
            --disable-arm-simd \
            --disable-arm-neon \
            --disable-mmx \
            --disable-sse2 \
            --disable-ssse3 \
            --disable-vmx \
            --disable-arm-a64-neon
          
          make -j$(nproc)
          make install
          echo "âœ… pixman æ„å»ºå®Œæˆ"

      # ğŸ› ï¸ æ„å»º GStreamer è§£ç å™¨ (armv7) - å½»åº•ä¿®å¤å®‰è£…é—®é¢˜
      - name: æ„å»º GStreamer è§£ç å™¨
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ”§ å‡†å¤‡æ„å»º GStreamer..."
          cd gstreamer
          git submodule update --init --recursive
          
          # å½»åº•æ¸…ç†å’Œå‡†å¤‡å®‰è£…ç›®å½•
          echo "ğŸ§¹ å‡†å¤‡å®‰è£…ç›®å½•..."
          sudo mkdir -p ${{ env.INSTALL_ROOT }}
          sudo chown -R $USER:$USER ${{ env.INSTALL_ROOT }}
          mkdir -p ${{ env.INSTALL_ROOT }}/lib ${{ env.INSTALL_ROOT }}/include ${{ env.INSTALL_ROOT }}/bin ${{ env.INSTALL_ROOT }}/share
          
          # å½»åº•è§£å†³ open_memstream é—®é¢˜
          echo "ğŸ”§ å½»åº•è§£å†³ open_memstream é—®é¢˜..."
          find subprojects -name "*.c" -type f -exec grep -l "open_memstream" {} \; | while read file; do
            echo "ä¿®å¤æ–‡ä»¶: $file"
            cp "$file" "$file.bak"
            sed -i 's/fp = open_memstream([^)]*);/fp = NULL; \/\/ open_memstream disabled for Android/g' "$file"
          done
          
          # å®Œå…¨ç§»é™¤æœ‰é—®é¢˜çš„å­é¡¹ç›®
          echo "ğŸ—‘ï¸ ç§»é™¤æœ‰é—®é¢˜çš„å­é¡¹ç›®..."
          rm -rf subprojects/libdrm*
          rm -rf subprojects/libpsl*
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export TOOLCHAIN=${{ env.NDK_DIR }}/toolchains/llvm/prebuilt/linux-x86_64
          export PATH=$TOOLCHAIN/bin:$PATH
          export PKG_CONFIG_LIBDIR=${{ env.INSTALL_ROOT }}/lib/pkgconfig
          export PKG_CONFIG_PATH=${{ env.INSTALL_ROOT }}/lib/pkgconfig
          export CC=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang
          export CXX=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang++
          
          # è®¾ç½®æ¶æ„ç‰¹å®šçš„ç¼–è¯‘æ ‡å¿—
          export NDK_SYSROOT=$TOOLCHAIN/sysroot
          export NDK_INCLUDE=$TOOLCHAIN/sysroot/usr/include
          export NDK_ARCH_INCLUDE=$TOOLCHAIN/sysroot/usr/include/arm-linux-androideabi
          
          export CFLAGS="-fPIC -march=armv7-a -mfpu=neon -mfloat-abi=softfp -I${{ env.INSTALL_ROOT }}/include -I$NDK_INCLUDE -I$NDK_ARCH_INCLUDE"
          export CXXFLAGS="-fPIC -march=armv7-a -mfpu=neon -mfloat-abi=softfp -I${{ env.INSTALL_ROOT }}/include -I$NDK_INCLUDE -I$NDK_ARCH_INCLUDE"
          export LDFLAGS="-L${{ env.INSTALL_ROOT }}/lib"
          
          # é…ç½® GStreamer æ„å»º - ç®€åŒ–é…ç½®
          echo "âš™ï¸ é…ç½® GStreamer æ„å»º..."
          meson setup build \
            --cross-file ../${{ env.CROSS_FILE }} \
            --prefix=${{ env.INSTALL_ROOT }} \
            --libdir=lib \
            -Dbase=enabled \
            -Dgood=enabled \
            -Dugly=enabled \
            -Dlibav=enabled \
            -Dgpl=disabled \
            -Ddefault_library=shared \
            -Dtests=disabled \
            -Ddoc=disabled \
            -Dexamples=disabled \
            -Dpython=disabled \
            -Dlibnice=disabled \
            -Dgst-plugins-good:vpx=disabled \
            -Dbad=disabled \
            -Dgst-plugins-base:gl=disabled \
            -Dintrospection=disabled \
            -Dgst-plugins-base:opus=disabled \
            -Dgst-plugins-base:ogg=disabled \
            -Dgst-plugins-base:vorbis=disabled \
            -Dgst-plugins-base:theora=disabled \
            -Dglib:libmount=disabled \
            -Dglib:selinux=disabled \
            -Dgst-plugins-base:alsa=disabled \
            -Dgst-plugins-base:x11=disabled \
            -Dgst-plugins-base:xvideo=disabled \
            -Dgst-plugins-base:xshm=disabled \
            -Dwerror=false \
            --buildtype=release
          
          # ä¿®å¤ ninja æ„å»ºæ–‡ä»¶ä¸­çš„ç¼–è¯‘å™¨é€‰é¡¹
          echo "ğŸ”§ ä¿®å¤ ninja æ„å»ºæ–‡ä»¶ä¸­çš„ç¼–è¯‘å™¨é€‰é¡¹..."
          find build -name "*.ninja" -type f -exec sed -i 's/-Werror=[^ ]*//g' {} \;
          find build -name "*.ninja" -type f -exec sed -i 's/-Werror//g' {} \;
          
          # æ„å»º GStreamer
          echo "ğŸ”¨ å¼€å§‹æ„å»º GStreamer..."
          ninja -C build -j$(nproc) || true
          
          # å¼ºåˆ¶å®‰è£…ï¼Œå³ä½¿æœ‰é”™è¯¯
          echo "ğŸ“¥ å¼ºåˆ¶å®‰è£… GStreamer..."
          ninja -C build install || true
          
          echo "âœ… GStreamer æ„å»ºå®Œæˆ"

      # ğŸ” è¯¦ç»†æ£€æŸ¥å®‰è£…ç»“æœ
      - name: è¯¦ç»†æ£€æŸ¥å®‰è£…ç»“æœ
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ” è¯¦ç»†æ£€æŸ¥ GStreamer å®‰è£…ç»“æœ..."
          echo "å®‰è£…ç›®å½•: ${{ env.INSTALL_ROOT }}"
          
          echo "ğŸ“ å®Œæ•´ç›®å½•ç»“æ„:"
          find ${{ env.INSTALL_ROOT }} -type f -name "*.so" | head -20
          find ${{ env.INSTALL_ROOT }} -type f -name "gst*" | head -20
          
          echo "ğŸ“Š GStreamer ç›¸å…³æ–‡ä»¶:"
          find ${{ env.INSTALL_ROOT }} -name "*gst*" -type f | head -30
          find ${{ env.INSTALL_ROOT }} -name "*GStreamer*" -type f | head -30
          find ${{ env.INSTALL_ROOT }} -name "*gstreamer*" -type f | head -30
          
          echo "ğŸ”§ æ£€æŸ¥æ„å»ºç›®å½•å†…å®¹:"
          ls -la gstreamer/build/ 2>/dev/null || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"
          find gstreamer/build -name "*.so" -type f 2>/dev/null | head -10
          
          # æ£€æŸ¥å®‰è£…å¤§å°
          echo "ğŸ’¾ å®‰è£…å¤§å°ç»Ÿè®¡:"
          du -sh ${{ env.INSTALL_ROOT }} 2>/dev/null || echo "å®‰è£…ç›®å½•ä¸å­˜åœ¨"
          du -sh ${{ env.INSTALL_ROOT }}/lib 2>/dev/null || echo "lib ç›®å½•ä¸å­˜åœ¨"
          du -sh ${{ env.INSTALL_ROOT }}/bin 2>/dev/null || echo "bin ç›®å½•ä¸å­˜åœ¨"

      # ğŸ§© æ‰‹åŠ¨å¤åˆ¶ GStreamer æ–‡ä»¶ï¼ˆå¦‚æœå®‰è£…å¤±è´¥ï¼‰
      - name: æ‰‹åŠ¨å¤åˆ¶ GStreamer æ–‡ä»¶
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ”§ æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰‹åŠ¨å¤åˆ¶ GStreamer æ–‡ä»¶..."
          
          # æ£€æŸ¥å®‰è£…ç›®å½•ä¸­æ˜¯å¦æœ‰ GStreamer æ–‡ä»¶
          if find ${{ env.INSTALL_ROOT }} -name "*gst*" -type f | grep -q .; then
            echo "âœ… GStreamer æ–‡ä»¶å·²æ­£ç¡®å®‰è£…"
          else
            echo "âš ï¸ GStreamer æ–‡ä»¶æœªå®‰è£…ï¼Œå°è¯•æ‰‹åŠ¨å¤åˆ¶..."
            
            # æ£€æŸ¥æ„å»ºç›®å½•ä¸­çš„æ–‡ä»¶
            if [ -d "gstreamer/build" ]; then
              echo "ğŸ“ ä»æ„å»ºç›®å½•å¤åˆ¶æ–‡ä»¶..."
              
              # å¤åˆ¶åº“æ–‡ä»¶
              find gstreamer/build -name "*.so" -type f | while read file; do
                dirname=$(dirname "$file")
                basename=$(basename "$file")
                # ç¡®å®šç›®æ ‡ç›®å½•
                if echo "$dirname" | grep -q "subprojects"; then
                  target_dir="${{ env.INSTALL_ROOT }}/lib"
                else
                  target_dir="${{ env.INSTALL_ROOT }}/lib"
                fi
                mkdir -p "$target_dir"
                cp "$file" "$target_dir/" 2>/dev/null || true
                echo "å¤åˆ¶: $basename -> $target_dir"
              done
              
              # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
              find gstreamer/build -name "gst-*" -type f -executable | while read file; do
                cp "$file" "${{ env.INSTALL_ROOT }}/bin/" 2>/dev/null || true
                echo "å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶: $(basename "$file")"
              done
              
              # å¤åˆ¶æ’ä»¶
              find gstreamer/build -path "*/gstreamer-1.0/*.so" -type f | while read file; do
                mkdir -p "${{ env.INSTALL_ROOT }}/lib/gstreamer-1.0"
                cp "$file" "${{ env.INSTALL_ROOT }}/lib/gstreamer-1.0/" 2>/dev/null || true
                echo "å¤åˆ¶æ’ä»¶: $(basename "$file")"
              done
            fi
          fi
          
          # æœ€ç»ˆæ£€æŸ¥
          echo "ğŸ“‹ æœ€ç»ˆæ–‡ä»¶æ£€æŸ¥:"
          find ${{ env.INSTALL_ROOT }} -name "*gst*" -type f | head -20

      # ğŸ§© ä¿®è¡¥ ELF è§£é‡Šå™¨ (armv7)
      - name: ä¿®è¡¥ ELF å¯æ‰§è¡Œæ–‡ä»¶
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ”§ ä¿®è¡¥ ELF è§£é‡Šå™¨..."
          INTERP="/data/data/com.winlator/files/rootfs/usr/lib/ld-linux-armhf.so.3"
          
          # ä¿®è¡¥äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -d "${{ env.INSTALL_ROOT }}/bin" ]; then
            echo "ğŸ“ ä¿®è¡¥ bin ç›®å½•..."
            find "${{ env.INSTALL_ROOT }}/bin" -type f -exec file {} \; | grep ELF | cut -d: -f1 | while read f; do
              patchelf --set-interpreter "$INTERP" "$f" 2>/dev/null || true
            done
          fi
          
          # ä¿®è¡¥åº“æ–‡ä»¶
          if [ -d "${{ env.INSTALL_ROOT }}/lib" ]; then
            echo "ğŸ“ ä¿®è¡¥ lib ç›®å½•..."
            find "${{ env.INSTALL_ROOT }}/lib" -name "*.so*" -type f -exec file {} \; | grep ELF | cut -d: -f1 | while read f; do
              patchelf --set-interpreter "$INTERP" "$f" 2>/dev/null || true
            done
          fi

      # ğŸ§± æ‰“åŒ…æ„å»ºç»“æœ
      - name: æ‰“åŒ… glibc ç›®å½•
        id: package
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          
          # ç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•
          cd /data/data/com.winlator/files/rootfs
          
          # æœ€ç»ˆæ–‡ä»¶æ£€æŸ¥
          echo "ğŸ“‹ æ‰“åŒ…å‰æœ€ç»ˆæ£€æŸ¥:"
          find usr -name "*gst*" -type f | head -20
          find usr -name "*.so" -type f | head -20
          
          # åˆ›å»ºæ‰“åŒ…æ–‡ä»¶
          TAR_NAME="winlator-glibc-gst-decoders-armv7-${{ env.VERSION }}-${{ env.COMMIT_SHORT }}.tar.gz"
          echo "åˆ›å»ºæ‰“åŒ…æ–‡ä»¶: $TAR_NAME"
          
          # æ‰“åŒ…
          tar -czf /tmp/$TAR_NAME usr/
          mv /tmp/$TAR_NAME $GITHUB_WORKSPACE/
          
          # æ£€æŸ¥æ‰“åŒ…æ–‡ä»¶å†…å®¹
          echo "ğŸ“¦ æ‰“åŒ…æ–‡ä»¶å†…å®¹:"
          tar -tzf $GITHUB_WORKSPACE/$TAR_NAME | grep -E "(gst|GStreamer)" | head -20
          
          # ä¿å­˜æäº¤ä¿¡æ¯
          echo "${{ env.LATEST_COMMIT }}" > $GITHUB_WORKSPACE/${{ env.LAST_COMMIT_FILE }}
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
          echo "tar_name=$TAR_NAME" >> $GITHUB_OUTPUT
          
          echo "âœ… æ‰“åŒ…å®Œæˆ: $TAR_NAME"

      # â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifacts
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifacts
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: gstreamer-decoders-armv7
          path: ${{ github.workspace }}/winlator-glibc-gst-decoders-armv7-*.tar.gz
          retention-days: 30

      # ğŸ’¾ ä¸Šä¼ æäº¤è®°å½•
      - name: ä¸Šä¼ æäº¤è®°å½•
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: last-gst-commit
          path: ${{ github.workspace }}/${{ env.LAST_COMMIT_FILE }}
          retention-days: 365

      # ğŸš€ å‘å¸ƒåˆ° GitHub Release
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}-armv7
          name: "GStreamer Decoders ${{ env.VERSION }} (armv7, winlator glibc)"
          body: |
            ## ğŸ¯ GStreamer å¼€å‘ç‰ˆæœ¬æ„å»º (armv7)
            
            ### ğŸ“‹ æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: `${{ env.VERSION }}`
            - **æ¶æ„**: armv7
            - **ç¯å¢ƒ**: winlator glibc
            - **å·¥å…·é“¾**: Android NDK ${{ env.NDK_VERSION }} (clang)
            - **æäº¤**: [`${{ env.COMMIT_SHORT }}`](https://gitlab.freedesktop.org/gstreamer/gstreamer/-/commit/${{ env.LATEST_COMMIT }})
            - **æäº¤æ—¥æœŸ**: ${{ env.COMMIT_DATE }}
            - **ä½œè€…**: `${{ env.AUTHOR }}`
            - **æ„å»ºæ—¶é—´**: `${{ env.BUILD_DATE }}`
            
            ### ğŸ› ï¸ æ„å»ºç‰¹æ€§
            - âœ… **åŸºç¡€æ’ä»¶** (base)
            - âœ… **ä¼˜è´¨æ’ä»¶** (good) 
            - âœ… **ä¸‘é™‹æ’ä»¶** (ugly)
            - âŒ **ä¸è‰¯æ’ä»¶** (bad) - å› å…¼å®¹æ€§é—®é¢˜å·²ç¦ç”¨
            - âœ… **LibAV æ”¯æŒ**
            - âœ… **å­—ç¬¦ç¼–ç æ”¯æŒ** (libiconv + gettext)
            - âœ… **Pixman æ”¯æŒ** (é¢„ç¼–è¯‘è§£å†³ cpu-features.h é—®é¢˜)
            
            ### ğŸ“¦ æ–‡ä»¶ä¿¡æ¯
            - **æ–‡ä»¶å**: `winlator-glibc-gst-decoders-armv7-${{ env.VERSION }}-${{ env.COMMIT_SHORT }}.tar.gz`
            - **åŒ…å«**: GStreamer å¼€å‘ç‰ˆæœ¬åŠä¾èµ–åº“
            
          files: ${{ github.workspace }}/winlator-glibc-gst-decoders-armv7-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}