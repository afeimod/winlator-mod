name: winlator GStreamer Decoders (aarch64, Dev + libvpx)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'
  pull_request:

permissions:
  contents: write
  packages: write

env:
  LAST_COMMIT_FILE: last_gst_commit.txt
  INSTALL_ROOT: /data/data/com.winlator/files/rootfs/usr
  WINLATOR_ROOT: /data/data/com.winlator/files/rootfs
  WINLATOR_PREFIX: /data/data/com.winlator/files/rootfs/usr
  WINLATOR_LIB: /data/data/com.winlator/files/rootfs/usr/lib
  WINLATOR_INC: /data/data/com.winlator/files/rootfs/usr/include
  GST_PLUGINS_PATH: /data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps: 
      # ğŸ§© æ£€å‡ºä»“åº“
      - name: æ£€å‡º workflow ä»“åº“
        uses: actions/checkout@v4

      # ğŸ“¦ å®‰è£…åŸºç¡€ä¾èµ–
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-pip git pkg-config nasm \
            libglib2.0-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            liborc-0.4-dev libxv-dev libx11-dev libasound2-dev libpulse-dev patchelf \
            libtheora-dev libx264-dev libx265-dev libvpx-dev

      # âš™ï¸ å‡çº§ Meson å’Œ Ninja
      - name: å‡çº§ Meson å’Œ Ninja
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja

      # ğŸ”§ è®¾ç½® Winlator ç¼–è¯‘ä¸é“¾æ¥è·¯å¾„
      - name: è®¾ç½® Winlator ç¼–è¯‘ç¯å¢ƒ
        run: |
          echo "export LDFLAGS='-L${{ env.WINLATOR_LIB }} -Wl,--dynamic-linker=${{ env.WINLATOR_LIB }}/ld-linux-aarch64.so.1 -Wl,-rpath,${{ env.WINLATOR_LIB }}:${{ env.GST_PLUGINS_PATH }} -Wl,-rpath-link,${{ env.WINLATOR_LIB }}'" >> $GITHUB_ENV
          echo "export CFLAGS='-I${{ env.WINLATOR_INC }}'" >> $GITHUB_ENV
          echo "export CXXFLAGS='-I${{ env.WINLATOR_INC }}'" >> $GITHUB_ENV
          echo "export LD_LIBRARY_PATH='${{ env.WINLATOR_LIB }}:${{ env.GST_PLUGINS_PATH }}:\$LD_LIBRARY_PATH'" >> $GITHUB_ENV
          echo "export PKG_CONFIG_PATH='${{ env.WINLATOR_LIB }}/pkgconfig:${{ env.WINLATOR_LIB }}/aarch64-linux-gnu/pkgconfig:\$PKG_CONFIG_PATH'" >> $GITHUB_ENV
          echo "export GST_PLUGIN_PATH='${{ env.GST_PLUGINS_PATH }}'" >> $GITHUB_ENV
          echo "export GST_PLUGIN_SYSTEM_PATH='${{ env.GST_PLUGINS_PATH }}'" >> $GITHUB_ENV

          echo "âœ… å·²è®¾ç½® Winlator ç¯å¢ƒå˜é‡"

      # ğŸ§¬ å…‹éš† GStreamer å¼€å‘ç‰ˆæœ¬
      - name: å…‹éš† GStreamer å¼€å‘ç‰ˆæœ¬
        run: git clone --depth=1 https://gitlab.freedesktop.org/gstreamer/gstreamer.git

      # ğŸ” è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
      - name: è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
        id: get_dev_info
        run: |
          cd gstreamer
          LATEST_COMMIT=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          COMMIT_DATE=$(git log -1 --pretty=format:'%cd' --date=short)
          VERSION=$(sed -n '2p' "meson.build" | grep -oP "version\\s*:\\s*'\\K[^']+")
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "BUILD_DATE=$DATE" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV

      # ğŸ’¾ è·å–ä¸Šæ¬¡æ„å»ºæäº¤
      - name: è·å–ä¸Šæ¬¡æ„å»ºæäº¤
        id: get_last_commit
        run: |
          FILE=${{ env.LAST_COMMIT_FILE }}
          if [ -f "$FILE" ]; then
            LAST_COMMIT=$(cat "$FILE")
          else
            echo "none" > "$FILE"
            LAST_COMMIT="none"
          fi
          echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV

      # ğŸ” åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "skip_build=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ æäº¤æœªæ›´æ–°ï¼Œè·³è¿‡æ„å»ºã€‚"
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°æ–°æäº¤: $LATEST_COMMIT"
          fi

      # â­ï¸ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: exit 0

      # ğŸ§± æ„å»º libvpx v1.14.0
      - name: æ„å»º libvpx v1.14.0
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          git clone https://chromium.googlesource.com/webm/libvpx
          cd libvpx
          git checkout v1.14.0
          ./configure \
            --prefix=${{ env.WINLATOR_PREFIX }} \
            --libdir=${{ env.WINLATOR_LIB }} \
            --enable-shared \
            --enable-vp8 \
            --enable-vp9 \
            --enable-runtime-cpu-detect \
            --target=arm64-linux-gcc \
            --as=nasm \
            --disable-examples \
            --disable-docs
          make -j$(nproc)
          sudo make install
          echo "âœ… libvpx v1.14.0 å·²å®‰è£…åˆ° ${{ env.WINLATOR_LIB }}"

      # ğŸ› ï¸ æ„å»º GStreamer è§£ç å™¨ï¼ˆä½¿ç”¨ DESTDIR è€Œé prefixï¼‰
      - name: æ„å»º GStreamer è§£ç å™¨
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          cd gstreamer
          git submodule update --init --recursive
          sudo mkdir -p ${{ env.WINLATOR_PREFIX }}
          sudo chmod -R 777 ${{ env.WINLATOR_ROOT }}
          
          echo "ğŸ”§ é…ç½® Meson æ„å»ºç³»ç»Ÿ..."
          # ä½¿ç”¨ DESTDIR è€Œä¸æ˜¯ prefix æ¥é¿å…ç¡¬ç¼–ç è·¯å¾„
          meson setup build \
            -Dprefix=/usr \
            --libdir=lib \
            -Dbase=enabled \
            -Dpackage-origin="gstreamer-winlator" \
            -Dgood=enabled \
            -Dugly=enabled \
            -Dbad=enabled \
            -Dlibav=enabled \
            -Dgpl=enabled \
            -Ddefault_library=shared \
            -Dtests=disabled \
            -Ddoc=disabled \
            -Dexamples=disabled \
            -Dpython=disabled \
            -Dnls=disabled \
            -Dgst-plugins-libav:aac=disabled \
            -Dgst-plugins-good:vpx=enabled \
            -Dgst-plugins-bad:hip=disabled \
            -Dgst-plugins-bad:nvcodec=disabled \
            -Dgst-plugins-base:gl=disabled \
            -Dintrospection=disabled \
            -Dgst-full=enabled \
            -Ddevtools=disabled \
            -Dtools=disabled \
            -Drtsp_server=disabled \
            --buildtype=release
          
          echo "ğŸ—ï¸ å¼€å§‹ç¼–è¯‘..."
          ninja -C build -j$(nproc)
          
          echo "ğŸ“¦ å®‰è£…åˆ°ç›®æ ‡ç›®å½•..."
          DESTDIR=${{ env.WINLATOR_ROOT }} ninja -C build install
          
          echo "âœ… GStreamer æ„å»ºå®Œæˆ"

      # ğŸ”§ æ·±åº¦æ¸…ç†å’Œä¿®æ­£ ELF æ–‡ä»¶
      - name: æ·±åº¦æ¸…ç†å’Œä¿®æ­£ ELF æ–‡ä»¶
        if: steps.check_build.outputs.skip_build == 'false'
        shell: bash
        run: |
          echo "ğŸ”§ æ·±åº¦æ¸…ç† ELF æ–‡ä»¶è·¯å¾„..."
          
          # åˆ›å»ºæ·±åº¦æ¸…ç†è„šæœ¬
          cat > deep_clean_elf.sh << 'EOF'
          #!/bin/bash
          WINLATOR_LIB="$1"
          GST_PLUGINS_PATH="$2"
          
          echo "ğŸ—‘ï¸ æ¸…ç†æ„å»ºè·¯å¾„å¹¶è®¾ç½®æ­£ç¡® RPATH..."
          
          # æŸ¥æ‰¾æ‰€æœ‰ ELF æ–‡ä»¶å¹¶æ¸…ç†è·¯å¾„
          find "$WINLATOR_LIB" -type f \( -name "*.so" -o -name "*.so.*" \) | while read -r file; do
            if file "$file" | grep -q "ELF.*shared object"; then
              echo "ğŸ§¹ æ¸…ç†: $(basename "$file")"
              
              # é¦–å…ˆç§»é™¤æ‰€æœ‰ RPATH
              patchelf --remove-rpath "$file" 2>/dev/null || true
              
              # è®¾ç½®çº¯å‡€çš„ RPATH
              patchelf --set-rpath "$WINLATOR_LIB:$GST_PLUGINS_PATH" "$file" 2>/dev/null || true
              
              # æ£€æŸ¥å¹¶æ¸…ç†ä¾èµ–é¡¹
              ldd_output=$(ldd "$file" 2>/dev/null || true)
              if echo "$ldd_output" | grep -q "not found"; then
                echo "âš ï¸  å‘ç°æœªè§£æä¾èµ–: $file"
              fi
            fi
          done
          
          # å¤„ç†å¯æ‰§è¡Œæ–‡ä»¶
          find "$WINLATOR_LIB/../bin" -type f 2>/dev/null | while read -r file; do
            if file "$file" | grep -q "ELF.*executable"; then
              echo "ğŸ”§ ä¿®æ­£å¯æ‰§è¡Œæ–‡ä»¶: $(basename "$file")"
              patchelf --remove-rpath "$file" 2>/dev/null || true
              patchelf --set-rpath "$WINLATOR_LIB:$GST_PLUGINS_PATH" "$file" 2>/dev/null || true
              patchelf --set-interpreter "$WINLATOR_LIB/ld-linux-aarch64.so.1" "$file" 2>/dev/null || true
            fi
          done
          
          # ç‰¹åˆ«å¤„ç† gstreamer æ’ä»¶
          find "$GST_PLUGINS_PATH" -type f -name "*.so" | while read -r file; do
            if file "$file" | grep -q "ELF.*shared object"; then
              echo "ğŸ”Œ æ¸…ç†æ’ä»¶: $(basename "$file")"
              patchelf --remove-rpath "$file" 2>/dev/null || true
              patchelf --set-rpath "$WINLATOR_LIB:$GST_PLUGINS_PATH" "$file" 2>/dev/null || true
            fi
          done
          
          echo "âœ… æ·±åº¦æ¸…ç†å®Œæˆ"
          EOF
          
          chmod +x deep_clean_elf.sh
          ./deep_clean_elf.sh "${{ env.WINLATOR_LIB }}" "${{ env.GST_PLUGINS_PATH }}"

      # ğŸ”„ åˆ›å»ºæ­£ç¡®çš„ gstreamer é…ç½®
      - name: åˆ›å»º gstreamer ç¯å¢ƒé…ç½®
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ“ åˆ›å»º GStreamer ç¯å¢ƒé…ç½®æ–‡ä»¶..."
          
          # åˆ›å»º gstreamer é…ç½®ç›®å½•
          mkdir -p ${{ env.WINLATOR_PREFIX }}/etc/gstreamer-1.0
          
          # åˆ›å»º gst-env ç¯å¢ƒé…ç½®æ–‡ä»¶
          cat > ${{ env.WINLATOR_PREFIX }}/etc/gstreamer-1.0/gst-env << 'EOF'
            #!/bin/bash
            # GStreamer Winlator ç¯å¢ƒé…ç½®
            export GST_PLUGIN_PATH="/data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0"
            export GST_PLUGIN_SYSTEM_PATH="/data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0"
            export LD_LIBRARY_PATH="/data/data/com.winlator/files/rootfs/usr/lib:/data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0:$LD_LIBRARY_PATH"
            export PATH="/data/data/com.winlator/files/rootfs/usr/bin:$PATH"
            export PKG_CONFIG_PATH="/data/data/com.winlator/files/rootfs/usr/lib/pkgconfig:$PKG_CONFIG_PATH"
          EOF
          
          chmod +x ${{ env.WINLATOR_PREFIX }}/etc/gstreamer-1.0/gst-env
          
          # åˆ›å»º gst-plugin-scanner åŒ…è£…å™¨
          cat > ${{ env.WINLATOR_PREFIX }}/bin/gst-plugin-scanner-wrapper << 'EOF'
#!/bin/bash
export GST_PLUGIN_PATH="/data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0"
export GST_PLUGIN_SYSTEM_PATH="/data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0"
export LD_LIBRARY_PATH="/data/data/com.winlator/files/rootfs/usr/lib:/data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0:$LD_LIBRARY_PATH"
exec /data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0/gst-plugin-scanner "$@"
EOF
          
          chmod +x ${{ env.WINLATOR_PREFIX }}/bin/gst-plugin-scanner-wrapper
          echo "âœ… GStreamer ç¯å¢ƒé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"

      # ğŸ§ª éªŒè¯æ„å»ºç»“æœ
      - name: éªŒè¯æ„å»ºç»“æœ
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºç»“æœ..."
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          echo "ğŸ“ æ£€æŸ¥å®‰è£…çš„æ–‡ä»¶:"
          find ${{ env.WINLATOR_LIB }} -name "*.so" | head -10
          
          # æ£€æŸ¥ RPATH è®¾ç½®
          echo "ğŸ”§ æ£€æŸ¥ RPATH è®¾ç½®:"
          for lib in ${{ env.GST_PLUGINS_PATH }}/*.so; do
            if [ -f "$lib" ]; then
              rpath=$(patchelf --print-rpath "$lib" 2>/dev/null || echo "none")
              echo "  $(basename "$lib"): $rpath"
            fi
            break
          done
          
          echo "âœ… éªŒè¯å®Œæˆ"

      # ğŸ§± æ‰“åŒ…æ„å»ºç»“æœ
      - name: æ‰“åŒ… usr ç›®å½•
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          cd ${{ env.WINLATOR_ROOT }}
          TAR_NAME="winlator-gst-decoders-${VERSION}.tar.gz"
          tar -czvf /home/runner/$TAR_NAME usr
          echo "$LATEST_COMMIT" > ${{ env.LAST_COMMIT_FILE }}
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV

      # â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

      # ğŸ’¾ ä¸Šä¼ æäº¤è®°å½•
      - name: ä¸Šä¼ æäº¤è®°å½•
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: last-gst-commit
          path: ${{ env.LAST_COMMIT_FILE }}
          retention-days: 365

      # ğŸš€ å‘å¸ƒåˆ° GitHub Releaseï¼ˆä¿®æ­£æƒé™ï¼‰
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: gst-${{ env.VERSION }}
          name: "GStreamer Decoders ${{ env.VERSION }} (aarch64, Winlator)"
          body: |
            ## ğŸ¯ GStreamer å¼€å‘ç‰ˆæœ¬æ„å»º

            ### ğŸ“‹ æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: `${{ env.VERSION }}`
            - **æ¶æ„**: aarch64
            - **ç¯å¢ƒ**: Winlator
            - **æäº¤**: [`${{ env.COMMIT_SHORT }}`](https://gitlab.freedesktop.org/gstreamer/gstreamer/-/commit/${{ env.LATEST_COMMIT }})
            - **æäº¤æ—¥æœŸ**: ${{ env.COMMIT_DATE }}
            - **ä½œè€…**: `${{ env.AUTHOR }}`
            - **æ„å»ºæ—¶é—´**: `${{ env.BUILD_DATE }}`

            ### ğŸ› ï¸ æ„å»ºç‰¹æ€§
            - âœ… ä½¿ç”¨ DESTDIR å®‰è£…ï¼Œé¿å…ç¡¬ç¼–ç è·¯å¾„
            - âœ… æ·±åº¦æ¸…ç† ELF æ–‡ä»¶ RPATH
            - âœ… Base / Good / Ugly / Bad / LibAV å…¨å¯ç”¨
            - âœ… VP8/VP9 è§£ç æ”¯æŒ

            ### ğŸ“¦ æ–‡ä»¶ä¿¡æ¯
            - **æ–‡ä»¶å**: `${{ env.TAR_NAME }}`
            - **å®‰è£…è·¯å¾„**: `/data/data/com.winlator/files/rootfs/usr`
            - **åº“è·¯å¾„**: `/data/data/com.winlator/files/rootfs/usr/lib`
            - **æ’ä»¶è·¯å¾„**: `/data/data/com.winlator/files/rootfs/usr/lib/gstreamer-1.0`

            ### ğŸ“¥ å®‰è£…è¯´æ˜
            ```bash
            tar -xzvf ${{ env.TAR_NAME }} -C /data/data/com.winlator/files/rootfs
            source /data/data/com.winlator/files/rootfs/usr/etc/gstreamer-1.0/gst-env
            ```

            ### ğŸ”§ æµ‹è¯•å‘½ä»¤
            ```bash
            gst-inspect-1.0 --version
            gst-inspect-1.0 vp8dec
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}